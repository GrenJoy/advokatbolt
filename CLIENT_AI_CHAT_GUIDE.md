# AI Чат для клиентов - Руководство

## Обзор

Система AI чата для клиентов позволяет вести интеллектуальный диалог с AI ассистентом, который имеет доступ к контексту конкретного клиента. Контекст может включать:

- Информацию о клиенте (имя, email, телефон, адрес, дополнительная информация)
- OCR текст из загруженных документов клиента
- Связанные дела клиента
- Заметки, связанные с клиентом

## Архитектура

### Frontend компоненты

1. **ClientAIChat.tsx** - Основной компонент чата
   - Отображает историю сообщений
   - Управляет настройками контекста
   - Отправляет сообщения на сервер

2. **useAIContext.ts** - Хук для управления контекстом
   - Генерация кеша контекста
   - Управление опциями контекста
   - Очистка кеша

3. **ClientDetails.tsx** - Страница деталей клиента
   - Содержит вкладку с AI чатом
   - Интегрирует все компоненты клиента

### Backend API

1. **POST /api/chat/client** - Отправка сообщения
   ```json
   {
     "message": "текст сообщения",
     "clientId": "uuid клиента",
     "sessionId": "id сессии (опционально)",
     "contextCacheId": "id кеша контекста (опционально)"
   }
   ```

2. **GET /api/chat/client/:clientId/history** - История чата
   - Возвращает историю сообщений для клиента
   - Поддерживает фильтрацию по sessionId

3. **DELETE /api/chat/client/:clientId/clear** - Очистка истории
   - Удаляет всю историю чата для клиента

### База данных

1. **ai_context_cache** - Кеш контекста
   - Хранит сгенерированный контекст
   - Автоматически истекает через 7 дней
   - Содержит хеш для проверки изменений

2. **ai_chat_sessions** - Сессии чата
   - Группирует сообщения по сессиям
   - Связана с конкретным клиентом/делом

3. **ai_chat_messages** - Сообщения чата
   - Хранит историю диалога
   - Содержит контекстные данные

## Использование

### 1. Переход к чату клиента

1. Откройте страницу "Клиенты"
2. Нажмите на меню (три точки) у нужного клиента
3. Выберите "Просмотр"
4. Перейдите на вкладку "AI Чат"

### 2. Настройка контекста

В настройках чата можно включить/выключить:
- ✅ Информацию о клиенте
- ✅ OCR текст из документов
- ✅ Связанные дела
- ✅ Заметки

### 3. Генерация контекста

- При первом сообщении контекст генерируется автоматически
- Можно вручную обновить контекст кнопкой "Сгенерировать контекст"
- Контекст кешируется для оптимизации

### 4. Очистка данных

- **Очистить чат** - удаляет историю текущего чата
- **Полная очистка кеша** - удаляет весь AI кеш для всех клиентов

## Примеры использования

### Пример 1: Анализ клиента
```
Пользователь: Расскажи что ты знаешь об этом клиенте
AI: На основе доступной информации о клиенте [имя], могу сказать...
```

### Пример 2: Работа с документами
```
Пользователь: Какие документы есть у клиента?
AI: У клиента загружено X документов. Вот основная информация...
```

### Пример 3: Юридический анализ
```
Пользователь: Какие юридические риски есть у клиента?
AI: Анализируя документы и информацию о клиенте, выделю следующие риски...
```

## Технические детали

### Оценка токенов
- Примерная оценка: 4 символа = 1 токен для русского текста
- Отображается счетчик токенов в интерфейсе

### Ограничения
- Максимум 100 сообщений на сессию
- Сессии автоматически удаляются через 24 часа неактивности
- Контекст кешируется на 7 дней

### Безопасность
- Все данные хранятся изолированно по клиентам
- Доступ только для авторизованных пользователей
- История чата привязана к конкретному юристу

## Отладка

### Проверка работы кеша
1. Откройте инструменты разработчика (F12)
2. Перейдите на вкладку Network
3. Следите за запросами при генерации контекста

### Логи сервера
- Ошибки OCR: проверьте консоль сервера
- Ошибки AI: проверьте ответы API

### Частые проблемы

1. **Контекст не генерируется**
   - Проверьте наличие данных у клиента
   - Убедитесь что выбраны опции контекста

2. **Чат не отвечает**
   - Проверьте работу сервера на порту 3001
   - Убедитесь что GEMINI_API_KEY установлен

3. **OCR не работает**
   - Проверьте что документы загружены как изображения
   - Убедитесь что OCR обработка завершена